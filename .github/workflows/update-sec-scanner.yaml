name: Update sec-scanners-config.yaml
on:
  schedule:
    - cron: '21 * * * *'
permissions:
  contents: write
  pull-requests: write

jobs:
  update-sec-scanners:
    name: update sec-scanners-config.yaml
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: get latest tag
        id: ensure-head-sha
        env:
          IMAGE_TAG_REGEXP: v[0-9]{8}-[a-f0-9]{6,9}
        run: |
          # grab HEAD SHA and check if it contains the tag
          HEAD_SHA="$(git rev-parse HEAD)"
          if ! skopeo inspect "docker://europe-docker.pkg.dev/kyma-project/prod/istio/main/istio-manager:$HEAD_SHA"; then
            echo "::warning::The repository does not contain an image assigned to HEAD tag"
            exit 0
          fi
          echo "image-tag=$HEAD_SHA" >> "$GITHUB_OUTPUT"
      - name: Schedule security-config update
        if: steps.ensure-head-sha.outputs.image-tag != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git fetch origin
          git checkout -f autobump/sec-scanners-config
          git reset --hard origin/main
          sed -i "s/europe-docker\.pkg\.dev\/kyma-project\/prod\/istio\/main\/istio-manager\:.*/europe-docker\.pkg\.dev\/kyma-project\/prod\/istio\/main\/istio-manager\:$IMAGE_TAG/" sec-scanners-config.yaml
          git add .
          if git diff-index --quiet HEAD; then
            echo "No changes detected - no action required"
            exit 0
          fi
          git commit -m "chore: automatic update sec-scanners-config.yaml" -m "Generated by GitHub Actions"
          git push -f -u origin autobump/sec-scanners-config
          gh pr create --base main --head autobump/sec-scanners-config --fill || true
